[Back](../README.md)

<hr>

## Message Acknowledge


> In RabbitMQ, Ack (Acknowledgment) is a key mechanism for ensuring that messages are correctly processed by consumers. When Ack is enabled, the consumer must explicitly notify RabbitMQ that the message has been processed before RabbitMQ will delete the message from the queue. If the consumer does not send an Ack and the connection is lost, RabbitMQ will redistribute the message to other consumers.

#### Ack settings are mainly on the consumer side and are controlled in the following two ways:

### 1. Automatic Ack (autoAck = true)


This is the default configuration. Once a message is received by a consumer, RabbitMQ immediately considers it processed and deletes it, without the need for the consumer to manually acknowledge it.


- Risk: 
  If the consumer crashes while processing a message, the message will be lost (because RabbitMQ has deleted it).

  <hr>

- sample code:
  ```java
  // The second parameter is autoAck, true means automatic confirmation
  channel.basicConsume(queueName, true, deliverCallback, cancelCallback);
  ```
&nbsp;

### 2. Manual Ack (autoAck = false)

The Ack method needs to be called explicitly to inform RabbitMQ that the message has been processed. This is recommended for actual production to ensure that the message is not lost.

- Steps:
  1) After receiving a message, the consumer processes the business logic.

  2) If the processing is successful, the consumer calls basicAck to acknowledge the message.

  3) If the processing fails, the consumer calls basicNack or basicReject to requeue or discard the message.

  <hr>

- sample code:
  ```java
  // 1. Disable automatic acknowledgment (autoAck = false)
  channel.basicConsume(queueName, false, (consumerTag, delivery) -> {
      String message = new String(delivery.getBody(), StandardCharsets.UTF_8);
      
      try {
          // 2. Process the message (e.g.: business logic)
          System.out.println("Processing message: " + message);
          
          // 3. Manual acknowledgment (multiple = false means only acknowledge the current message)
          channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
      } catch (Exception e) {
          // 4. Processing failed: reject message and requeue it (requeue = true)
          channel.basicNack(delivery.getEnvelope().getDeliveryTag(), false, true);
          // Alternatively use basicReject (can only reject a single message)
          // channel.basicReject(delivery.getEnvelope().getDeliveryTag(), true);
      }
  }, consumerTag -> {});
  ```


- Key Parameter Explanations
  - **deliveryTag:** 
    A unique identifier for the message, generated by RabbitMQ, used to acknowledge specific messages.
  - **multiple** (for basicAck/basicNack):
    - true: Acknowledge all messages with a deliveryTag less than the current value (batch acknowledgment).
    - false: Acknowledge only the message corresponding to the current deliveryTag.
  - **requeue** (for basicNack/basicReject):
    - true: The message is requeued and can be processed by other consumers.
    - false: The message is discarded (or routed to a dead-letter queue if pre-configured).

- Notes
  - **Manual Ack must be called:** 
  If autoAck = false but basicAck is not invoked, the message will remain in the queue with unacked status until the consumer connection is closed, after which it will change to ready status.
  - **Avoid duplicate consumption:** 
  When processing fails and messages are requeued (requeue = true), ensure your business logic is idempotent (repeated processing will not cause side effects).
  - **Batch acknowledgment:**
  Using multiple = true can improve efficiency but requires ensuring all messages in the batch have been successfully processed.

#### The manual Ack mechanism effectively ensures message reliability and is one of the core methods for preventing message loss in RabbitMQ.

