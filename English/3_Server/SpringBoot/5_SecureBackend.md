[Back](README.md)

## Secure Backend

<hr>


### 1. What is Spring Security

> Spring Security (https://spring.io/projects/spring-security) provides security services for Java-based web applications.

By default, Spring Security enables the following features:
    

- AuthenticationManager bean(an in-memory single user)
    > The username is user and the password is printed to the console output

- Ignored paths for common static resource locations
    > eg: /css and /images

- HTTP basic authentication for all other endpoints
    > A default autogenerated login page

- Security events published to Spring’s ApplicationEventPublisher interface

- Common low-level features turned on by default
    > HTTP Strict Transport Security (HSTS), cross-site scripting (XSS), and cross-site request forgery (CSRF)

&nbsp;

### 2. Add Spring Security

2-1) add dependencies in build.gradle

```groovy
dependencies {
	...
	implementation 'org.springframework.boot:spring-boot-starter-security'
	...
	testImplementation 'org.springframework.security:spring-security-test'
}
```

<hr>

2-2) start your application

You can see from the console that Spring Security has created an in-memory user with a username of user. The user’s password can be seen in the console output.

<hr>

2-3) Check


Open your web browser and navigate to http://localhost:8080/api. You will be redirected to the Spring Security default login page(with username and password).

Type user into the Username field and copy the generated password from the console to the Password field. With authentication, we can see that the response contains our API resources.

&nbsp;

### 3. Customize Spring Security

To configure how Spring Security behaves, we have to add a new configuration class for Spring Security. You can also define the authentication mechanism, the login 
process, session management, and so on.

3-1) Create a new class called SecurityConfig in your application root package

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
@Configuration
@EnableWebSecurity
public class SecurityConfig {
}
```

<hr>

3-2) Add in-memory users to our application by using Spring Security’s 
InMemoryUserDetailsManager

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
	@Bean
	public InMemoryUserDetailsManager userDetailsService() {
	UserDetails user = User.builder().username("user")
		.password(passwordEncoder().encode("password"))
		.roles("USER").build();
		return new InMemoryUserDetailsManager(user);
	}

	@Bean
	public PasswordEncoder passwordEncoder() {
		return new BCryptPasswordEncoder();
	}
}
```

&nbsp;

### 4. Save users to the database

To save users to the database, you have to create a user entity class and repository.

_Passwords shouldn’t be saved to the database in plaintext format. If a database containing user passwords is hacked, attackers will be able to get the passwords directly in plaintext. Spring Security provides multiple hashing algorithms, such as bcrypt, that you can use to hash passwords._

4-1) Create entity class

AppUser.java
```java
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;

@Entity
public class AppUser {
	@Id
	@GeneratedValue(strategy = GenerationType.AUTO)
	@Column(nullable = false, updatable = false)
	private Long id;
	@Column(nullable = false, unique = true)
	private String username;
	@Column(nullable = false)
	private String password;
	@Column(nullable = false)
	private String role;

	public AppUser() {
	}

	public AppUser(String username, String password, String role) {
		super();
		this.username = username;
		this.password = password;
		this.role = role;
	}

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public String getUsername() {
		return username;
	}

	public void setUsername(String username) {
		this.username = username;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public String getRole() {
		return role;
	}

	public void setRole(String role) {
		this.role = role;
	}
}
```

<hr>

4-2) Create repository class

AppUserRepository.java
```java
import java.util.Optional;

import org.springframework.data.repository.CrudRepository;
import org.springframework.data.rest.core.annotation.RepositoryRestResource;

@RepositoryRestResource(exported = false)
public interface AppUserRepository extends CrudRepository<AppUser, Long> {
	Optional<AppUser> findByUsername(String username);
}
```
